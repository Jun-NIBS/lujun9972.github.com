#+TITLE: 使用Emacs改进你的英文写作
#+AUTHOR: lujun9972
#+TAGS: Emacs之怒
#+DATE: [2018-06-03 日 21:05]
#+LANGUAGE:  zh-CN
#+OPTIONS:  H:6 num:nil toc:t \n:nil ::t |:t ^:nil -:nil f:t *:t <:nil

* ispell
ispell是Unix下的一个拼写(不仅仅是英文)检查工具，同时它也是Emacs用来调用ispell类工具进行拼写检查的插件名称。

之所以说是ispell类工具是因为Emacs的ispell插件不仅仅支持调用ispell来进行拼写检查，也支持调用aspell/hunspell来进行拼写检查。

而且事实上，aspell已经逐渐取代ispell成为主流。

** 安装aspell
既然Emacs是调用外部工具来做的拼写检查，那么第一步当然是要安装 =aspell= 了
#+BEGIN_SRC shell :dir /sudo:: :results org
  sudo pacman -S aspell --noconfirm
#+END_SRC

#+BEGIN_SRC org
resolving dependencies...
looking for conflicting packages...

Packages (1) aspell-0.60.6.1-5

Total Download Size:   0.57 MiB
Total Installed Size:  3.00 MiB

:: Proceed with installation? [Y/n] 
:: Retrieving packages...
 aspell-0.60.6.1-5-x...     0.0   B  0.00B/s 00:00 [----------------------]   0% aspell-0.60.6.1-5-x...   361.4 KiB   531K/s 00:00 [#############---------]  61% aspell-0.60.6.1-5-x...   587.9 KiB  1760K/s 00:00 [######################] 100%
(0/1) checking keys in keyring                     [----------------------]   0%(1/1) checking keys in keyring                     [######################] 100%
(0/1) checking package integrity                   [----------------------]   0%(1/1) checking package integrity                   [######################] 100%
(0/1) loading package files                        [----------------------]   0%(1/1) loading package files                        [######################] 100%
(0/1) checking for file conflicts                  [----------------------]   0%(1/1) checking for file conflicts                  [######################] 100%
(0/1) checking available disk space                [----------------------]   0%(1/1) checking available disk space                [######################] 100%
:: Processing package changes...
(1/1) installing aspell                            [----------------------]   0%(1/1) installing aspell                            [######################] 100%
Optional dependencies for aspell
    perl: to import old dictionaries [installed]
:: Running post-transaction hooks...
(1/2) Arming ConditionNeedsUpdate...
(2/2) Updating the info directory file...
#+END_SRC

不过光安装 =aspell= 并没什么鸟用，你还需要安装对应的字典.
#+BEGIN_SRC shell :results org
  pacman -Ss  aspell
#+END_SRC

#+BEGIN_SRC org
extra/aspell 0.60.6.1-5 [已安装]
    A spell checker designed to eventually replace Ispell
extra/aspell-de 20161207-1
    German dictionary for aspell
extra/aspell-en 2017.08.24-1
    English dictionary for aspell
extra/aspell-es 1.11-6
    Spanish dictionary for aspell
extra/aspell-fr 0.50.3-7
    French dictionary for aspell
extra/aspell-nl 0.50.2-4
    Dutch dictionary for aspell
community/aspell-ca 2.3.0-2
    Catalan dictionary for aspell
community/aspell-cs 20040614-8
    Czech dictionary for aspell
community/aspell-el 0.08-2
    Greek dictionary for aspell
community/aspell-hu 0.99.4.2-5
    Hungarian spellcheck dictionary for aspell
community/aspell-it 2.2_20050523-6
    Italian dictionary for aspell
community/aspell-pl 20171220-1
    Polish dictionary for aspell
community/aspell-pt 20161001-1
    Portuguese and Brazilian Portuguese dictionary for aspell
community/aspell-ru 0.99f7-7
    Russian dictionary for aspell
community/aspell-sv 0.51-1
    Swedish dictionary for aspell
community/aspell-uk 1.8.0-1
    Ukrainian dictionary for aspell
#+END_SRC

你可以看到aspell有很多个语言的字典，也就是支持多种语言的拼写检查，不过可惜的是不支持中文拼写检查(中文分词是个大问题)。

我们一般用的最多的应该是对英文进行拼写检查吧，因此这里我们来安装英文的字典
#+BEGIN_SRC shell :dir /sudo:: :results org
  sudo pacman -S aspell-en --noconfirm
#+END_SRC

#+BEGIN_SRC org
resolving dependencies...
looking for conflicting packages...

Packages (1) aspell-en-2017.08.24-1

Total Download Size:   1.06 MiB
Total Installed Size:  4.06 MiB

:: Proceed with installation? [Y/n] 
:: Retrieving packages...
 aspell-en-2017.08.2...     0.0   B  0.00B/s 00:00 [----------------------]   0% aspell-en-2017.08.2...   133.6 KiB   216K/s 00:04 [##--------------------]  12% aspell-en-2017.08.2...   551.5 KiB   827K/s 00:00 [###########-----------]  50% aspell-en-2017.08.2...  1087.1 KiB  1874K/s 00:01 [######################] 100%
(0/1) checking keys in keyring                     [----------------------]   0%(1/1) checking keys in keyring                     [######################] 100%
(0/1) checking package integrity                   [----------------------]   0%(1/1) checking package integrity                   [######################] 100%
(0/1) loading package files                        [----------------------]   0%(1/1) loading package files                        [######################] 100%
(0/1) checking for file conflicts                  [----------------------]   0%(1/1) checking for file conflicts                  [######################] 100%
(0/1) checking available disk space                [----------------------]   0%(1/1) checking available disk space                [######################] 100%
:: Processing package changes...
(1/1) installing aspell-en                         [----------------------]   0%(1/1) installing aspell-en                         [######################] 100%
:: Running post-transaction hooks...
(1/1) Arming ConditionNeedsUpdate...
#+END_SRC

你可以试着直接在shell中运行 =aspell -c /tmp/t.txt= 来进行拼写检查，然而你可能会得到一个错误提示
#+BEGIN_EXAMPLE
  [lujun9972@T430S ~]$ aspell -c /tmp/t.txt 
  错误：No word lists can be found for the language "zh_CN".
#+END_EXAMPLE

这是因为aspell会自动根据设置的 =LANG= 变量来查找对应的字典，结果当然是找不到中文的字典咯。

不过你可以通过 =-l en= 来指定语言代码为英文。

#+BEGIN_SRC shell
  aspell -c /tmp/t.txt -l en
#+END_SRC

[[file:./images/screenshot-15.png]]


** 配置ispell插件
Emacs的ispell插件会自动以此查找aspell,ispell和hunspell，并以第一个找到的程序为检查程序。 
因此大多数情况下，你无需特意手工设置拼写程序的名称(ispell-program-name)。

不过默认情况下，Emacs的ispell插件也会根据设置的 =LANG= 变量值来决定使用哪个字典来进行拼写检查，因此很大可能，你有必要设置一下ispell插件用来检查的字典。

ispell插件提供了两个变量来设置字典:

+ ispell-dictionary :: 用于设置全局的默认字典
+ ispell-local-dictionary :: 用来设置当前buffer局部使用的字典

#+BEGIN_SRC emacs-lisp
  (setq ispell-dictionary "en")
#+END_SRC

aspell程序本身还支持很多的选项参数，若要传递这些参数给aspell进程，则可以通过定义 =ispell-extra-args= 来实现。
比如下面配置让aspell不检查小于等于3个字符的单词
#+BEGIN_SRC emacs-lisp
  (setq ispell-extra-args '("\W" "3"))
#+END_SRC

** 使用Ispell进行拼写检查

*** ispell

*** ispell-word

*** ispell-minior-mode

*** ispell-complete-word

*** ispell-kill-ispell
* flyspell-mode
* langtool
[[https://www.languagetool.org/][langtool]]是一个能够提供语法和写作风格检查的工具，它同时提供了命令行和GUI两种风格的界面，这使的它很容易与Emacs进行整合。

** 下载langtool离线版
langtool提供了Desktop版本来作为离线使用. 一般来说, 离线版langtool的功能要比在线版弱一些，但是对于一般的使用也足够了。

1. 下载langtool zip压缩包
   #+BEGIN_SRC shell :results org :dir ~/Downloads
     wget https://www.languagetool.org/download/LanguageTool-4.1.zip 
   #+END_SRC

2. 解压langtool zip压缩包

   #+BEGIN_SRC shell :results none :dir ~/Downloads 
     unzip LanguageTool-4.1.zip
   #+END_SRC

** 安装Emacs的langtool插件
langtool插件并不是Emacs自带的, 你可以从MELPA上安装，或者自己从[[https://github.com/mhayashi1120/Emacs-langtool][github]]上下载

** 配置Emacs langtool插件
Emacs需要调用外部的langtool命令行工具来进行实际的检查工作，因此你首先需要指定langtool的命令行工具的地址:
#+BEGIN_SRC emacs-lisp
  (setq langtool-language-tool-jar "~/Downloads/LanguageTool-4.1/languagetool-commandline.jar")
#+END_SRC

langtool支持多种语言的语法检查，默认会自己推测所属的语系。
但这种推测可能不一定准确，尤其是英语系里面那么多的变体(Australian, Canadian, GB, New Zealand, South African, US)。
对此，你也可以明确指定一种语言：
#+BEGIN_SRC emacs-lisp
  (setq langtool-default-language "en-US")
#+END_SRC
关于langtool支持的语言列表，可以通过 =C-u M-x langtool-check= 来查看.

你还可以设置母语信息，langtool会根据你的母语对检测规则进行一些微调
#+BEGIN_SRC emacs-lisp
  (setq langtool-mother-tongue "zh-CN")
#+END_SRC

最后需要说明的是，langtool的规则十分繁复，其中甚至包括一些写作风格的规则检查。若将所有规则都应用起来，那么可能会出现很多误报的情况. 所幸langtool可以允许任意组合检查规则，根据需要我们可以禁止某些规则的检查。
#+BEGIN_SRC emacs-lisp
  (setq langtool-disabled-rules '("WHITESPACE_RULE"
                                  "EN_UNPAIRED_BRACKETS"
                                  "COMMA_PARENTHESIS_WHITESPACE"
                                  "EN_QUOTES"))
#+END_SRC
关于规则的说明，可以参见[[https://www.languagetool.org/languages/][这里]]

比如，这里
+ WHITESPACE_RULE的规则是不允许出现多个空格在一起，但实际上在编写org的时候常常需要靠多个空格进行缩进
+ EN_UNPAIRED_BRACKETS的规则是不允许出现不匹配的括号，但是在org中是可以出现 =1)=, =2)= 这样的列表的
+ COMMA_PARENTHESIS_WHITESPACE的规则不允许在逗号前或括号的前后出现空格，但是在org中，当用 =)= 来表示列表时，是需要在 =)= 后接上空格的
+ EN_QUOTES则不允许使用花引号,但是我一般图方便都是直接用键盘上的花引号来进行引用的。

** 使用langtool进行检查
使用langtool进行检查的步骤很简单。

1. 运行 =M-x langtool-check= 来进行检查

   若没有设置 =langtool-default-language= 的langtool会自动推测检查的语言类别，否则就使用该变量的指定类别来进行检查。

   但有时候你可能要临时指定另一种语言的规则来进行检查，则可以运行 =C-u M-x langtool-check=, 这会弹出一个列表，让你从中选择要应用的语言规则。

   [[file:./images/screenshot-17.png]]

   如上图所示，langtool检查完后会用红色标记出检测出问题的地方，将光标移动到红色位置就会在echo area中显示是根据哪条规则检测出来的问题，并给出修改意见。

   [[file:./images/screenshot-18.png]]

2. 运行 =langtool-correct-buffer= 修正检测出的问题

   langtool会依次跳转到各个检测出问题的地方，并给出修改意见

   [[file:./images/screenshot-19.png]]

   只要按下修改意见前的编号就能自动修复该问题了

3. 由于不是所有检测出来的问题都是真正有错误的地方，
   因此在修改完所有要修改的错误后，运行 =langtool-check-done= 来清除所有的问题标记.

* artbollocks-mode
