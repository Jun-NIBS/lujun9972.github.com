<!DOCTYPE html>
<html lang="en">
<head>
  <title>如何创建最小的容器镜像 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #ds-thread #ds-reset .ds-comment-body p a {color: #ff0;}
   #ds-thread #ds-reset .ds-comment-body p a:hover {color: #0ff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" href="https://lujun9972.github.io/media/css/main.css" type="text/css"/>
  <link rel="stylesheet" href="https://lujun9972.github.io/media/css/comment.css" type="text/css"/>
</head>

  <body><div class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="https://lujun9972.github.io/">暗无天日</a> <span class="subtitle">=============&gt;随便,谢谢</span></h1>
        <ul>
          <li><a href="https://lujun9972.github.io/years/">Years</a></li>
          <li><a href="https://lujun9972.github.io/authors/">Authors</a></li>
          <li><a href="https://lujun9972.github.io/tags/">Tags</a></li>
          <li><a href="https://lujun9972.github.io/about/">About</a></li>
          <li><a href="https://github.com/lujun9972/lujun9972.github.com">Github</a></li>
          <li><a href="https://lujun9972.github.io/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1 class="title">如何创建最小的容器镜像</h1>
<p>
优化容器镜像尺寸的方法一般是使用 alpine 或者 busybox 这类超轻量级的linux 作为 base image. 
</p>

<p>
然而，所谓容器说到底不过就是一堆进程而已，之所以要引入这些base image不过是为进程提供依赖的动态库而已。
</p>

<p>
也就是说，如果采取静态方式来编译程序的话，那么就可以完全省略掉base image，从而节省出一些空间。
</p>

<p>
比如，我们可以先创建一个示例程序：
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #bc6ec5;">#include</span><span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">iostream</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #4f97d7; font-weight: bold;">namespace</span> <span style="color: #a45bad;">std</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(){</span>
cout &lt;&lt; <span style="color: #2d9574;">"Hello World \n "</span>;
<span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
我们对它进行静态编译:
</p>
<div class="org-src-container">
<pre class="src src-shell">g++ -o hello -static hello.cpp
</pre>
</div>

<p>
现在编写Dockerfile
</p>
<div class="org-src-container">
<pre class="src src-conf">FROM scratch
ADD hello /
CMD [<span style="color: #2d9574;">"/hello"</span>]
</pre>
</div>

<p>
其中第一句 <code>FROM scratch</code> 中的 <code>scratch</code> 并不是parent镜像的名字，它表示Docker在构建该镜像时并不基于任何其他的镜像。
</p>

<p>
现在我们试一下，构建该镜像
</p>
<div class="org-src-container">
<pre class="src src-shell">docker build --tag scratch .
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Sending build context to Docker daemon  557.1kBSending build context to Docker daemon   11.7MBSending build context to Docker daemon   23.4MBSending build context to Docker daemon  34.54MBSending build context to Docker daemon  42.36MB
Step 1/3 : FROM scratch
 ---&gt; 
Step 2/3 : COPY hello /
 ---&gt; 645b80b836a7
Step 3/3 : CMD ["/hello"]
 ---&gt; Running in 762c0cb569cb
Removing intermediate container 762c0cb569cb
 ---&gt; b63cd83c8576
Successfully built b63cd83c8576
Successfully tagged scratch:latest
</pre>
</div>

<p>
我们来运行一下这个容器
</p>
<div class="org-src-container">
<pre class="src src-shell">docker run --rm scratch
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Hello World 

</pre>
</div>
<p>
容器能正常运行。
</p>

<p>
现在我们来看一下 Docker 镜像的大小
</p>
<div class="org-src-container">
<pre class="src src-shell">docker images
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">REPOSITORY                     TAG                 IMAGE ID            CREATED             SIZE
scratch                        latest              b63cd83c8576        4 minutes ago       2.15MB
lujun9972/archlinuxcn.docker   latest              9462714d994c        46 hours ago        628MB
silex/emacs                    master              05a842271d75        2 months ago        439MB
alpine                         latest              3fd9065eaf02        5 months ago        4.15MB
richxsl/rhel7                  latest              9c7b3825758a        3 years ago         245MB
</pre>
</div>

<p>
你会发现，scratch镜像只有2.15M，而相比之下alpine则有4.15M大小
</p>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2018-07-03</span>
            <span title="last modification date" class="post-info">2018-07-03</span>
            <span title="tags" class="post-info">:<a href="https://lujun9972.github.io/tags/linux和它的小伙伴">linux和它的小伙伴</a>:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a></span>
        </div>
    <script src="https://lujun9972.github.io/media/js/jquery-2.1.3.min.js"></script>
        <section>
            <h1>Comments</h1>
            <div id="comment-wrap">
                    <a class="disqus_label">使用 Disqus 评论</a>
    </ul>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         //var disqus_developer = 1;
         var preempt_signal=false;
         var disqus_identifier = "/blog/2018/07/03/如何创建最小的容器镜像/";
         var disqus_url = "https://lujun9972.github.io/blog/2018/07/03/如何创建最小的容器镜像/";
         var disqus_shortname = 'lujun9972';
         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             $('#disqus_thread').css('display','none');
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script>
     /* comments */
     var ego_disqus_thread=$('#disqus_thread');
     var ego_ds_label=$('.ds-thread');
     $('.disqus_label').click(function(){
         ego_disqus_thread.show();
         ego_ds_label.hide();
     });
     $('.ds-label').click(function(){
         ego_disqus_thread.hide();
         ego_ds_label.show();
     });
    </script>
        </section>
    <script src="https://lujun9972.github.io/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div></body>
</html>
