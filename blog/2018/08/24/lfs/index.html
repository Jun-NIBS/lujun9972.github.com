<!DOCTYPE html>
<html lang="en">
<head>
  <title>LFS - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="author" content="lujun9972" />
  <meta name="keywords" content="linux和它的小伙伴" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" media="screen" href="https://lujun9972.github.io/media/css/font.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="https://lujun9972.github.io/media/css/main.css" type="text/css">
  <link rel="stylesheet" href="https://lujun9972.github.io/media/css/kdComment.css" type="text/css">
  <script type="text/javascript"
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
</head>

  <body class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="https://lujun9972.github.io/">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z" fill="#ffff00"/>
          <path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z" fill="#ffff00"/>
          <path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z" fill="#ffff00"/>
        </svg>
      </div>
      <ul class="trigger">
        <li><a href="https://lujun9972.github.io/tags/">Tags</a></li>
        <li><a href="https://lujun9972.github.io/about/">About</a></li>
        <li><a href="">GitHub</a></li>
        <li><a href="https://lujun9972.github.io/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.gfsoso.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">LFS</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org02f0dbc">前置准备工具</a></li>
<li><a href="#org55219e4">配置构建环境</a></li>
<li><a href="#orgffa2ef9">构建交叉编译器</a>
<ul>
<li><a href="#orga46d1d2">设置好编译相关的变量</a></li>
<li><a href="#orgd8b744b">安装kernel headers</a></li>
<li><a href="#org1050e67">安装Binutils</a></li>
<li><a href="#org74e640c">静态编译的gcc</a></li>
<li><a href="#org6fb7de3">编译Glibc</a></li>
<li><a href="#orgb5e313a">最后再编译一次GCC，这次这个GCC会链接到上一步编译出来的Glibc中</a></li>
</ul>
</li>
<li><a href="#orge9accd8">构建Target Image</a>
<ul>
<li><a href="#orgc308bf0">构建BusyBox</a></li>
<li><a href="#orgcbabe8f">构建linux kernel</a></li>
<li><a href="#orgaf926f8">Bootscripts</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org02f0dbc" class="outline-2">
<h2 id="org02f0dbc">前置准备工具</h2>
<div class="outline-text-2" id="text-org02f0dbc">
<p>
在host主机上需要安装有 GCC,make,ncurses,perl以及grub-install
</p>

<p>
同时需要下载一些源代码包:
</p>

<ul class="org-ul">
<li>binutils-2.30.tar.xz</li>
<li>busybox-1.28.3.tar.bz2</li>
<li>clfs-embedded-bootscripts-1.0-pre5.tar.bz2</li>
<li>gcc-7.3.0.tar.xz</li>
<li>glibc-2.27.tar.xz</li>
<li>gmp-6.1.2.tar.bz2</li>
<li>linux-4.16.3.tar.xz</li>
<li>mpc-1.1.0.tar.gz</li>
<li>mpfr-4.0.1.tar.xz</li>
<li>zlib-1.2.11.tar.gz</li>
</ul>
</div>
</div>


<div id="outline-container-org55219e4" class="outline-2">
<h2 id="org55219e4">配置构建环境</h2>
<div class="outline-text-2" id="text-org55219e4">
<ol class="org-ol">
<li><p>
启用bash hash功能
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">set</span> +h
</pre>
</div></li>

<li><p>
新建目录/文件只有属主具有写权限
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">umask</span> 022
</pre>
</div></li>

<li><p>
设置环境变量
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">export</span> <span style="color: #a0522d;">LJOS</span>=~/LFS
mkdir -p ${<span style="color: #a0522d;">LJOS</span>}
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">LC_ALL</span>=POSIX
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PATH</span>=${<span style="color: #a0522d;">LJOS</span>}/cross-tools/bin:/bin:/usr/bin
</pre>
</div></li>

<li><p>
创建<a href="http://refspecs.linuxfoundation.org/fhs.shtml">Linux目录层级结构</a>
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir -pv ${<span style="color: #a0522d;">LJOS</span>}/{bin,boot{,grub},dev,{etc/,}opt,home,lib/{firmware,modules},lib64,mnt}
mkdir -pv ${<span style="color: #a0522d;">LJOS</span>}/{proc,media/{floppy,cdrom},sbin,srv,sys}
mkdir -pv ${<span style="color: #a0522d;">LJOS</span>}/var/{lock,log,mail,run,spool}
mkdir -pv ${<span style="color: #a0522d;">LJOS</span>}/var/{opt,cache,lib/{misc,locate},local}
install -dv -m 0750 ${<span style="color: #a0522d;">LJOS</span>}/root
install -dv -m 1777 ${<span style="color: #a0522d;">LJOS</span>}{/var,}/tmp
install -dv ${<span style="color: #a0522d;">LJOS</span>}/etc/init.d
mkdir -pv ${<span style="color: #a0522d;">LJOS</span>}/usr/{,local/}{bin,include,lib{,64},sbin,src}
mkdir -pv ${<span style="color: #a0522d;">LJOS</span>}/usr/{,local/}share/{doc,info,locale,man}
mkdir -pv ${<span style="color: #a0522d;">LJOS</span>}/usr/{,local/}share/{misc,terminfo,zoneinfo}
mkdir -pv ${<span style="color: #a0522d;">LJOS</span>}/usr/{,local/}share/man/man{1,2,3,4,5,6,7,8}
<span style="color: #a020f0;">for</span> dir<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">LJOS</span>}/usr{,/local}; <span style="color: #a020f0;">do</span>
    ln -sv share/{man,doc,info} ${<span style="color: #a0522d;">dir</span>}
<span style="color: #a020f0;">done</span>
</pre>
</div></li>

<li><p>
创建存放交叉编译工具链的目录
</p>
<div class="org-src-container">
<pre class="src src-shell">install -dv ${<span style="color: #a0522d;">LJOS</span>}/cross-tools{,/bin}
</pre>
</div></li>

<li><p>
创建各个配置文件
</p>

<p>
使用 <code>/proc/mounts</code> 的值作为LFS中的 <code>/etc/mtab</code> 文件
</p>
<div class="org-src-container">
<pre class="src src-shell">ln -svf ../proc/mounts ${<span style="color: #a0522d;">LJOS</span>}/etc/mtab
</pre>
</div>

<p>
创建 <code>/etc/passwd</code> 文件，这一步用来创建LFS中的root账户
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="color: #a0522d;">LJOS</span>}/etc/passwd &lt;&lt; <span style="color: #8b2252;">"EOF"</span>
<span style="color: #ffa54f;">root::0:0:root:/root:/bin/ash</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
创建 <code>/etc/group</code> 文件
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="color: #a0522d;">LJOS</span>}/etc/group &lt;&lt; <span style="color: #8b2252;">"EOF"</span>
<span style="color: #ffa54f;">root:x:0:</span>
<span style="color: #ffa54f;">bin:x:1:</span>
<span style="color: #ffa54f;">sys:x:2:</span>
<span style="color: #ffa54f;">kmem:x:3:</span>
<span style="color: #ffa54f;">tty:x:4:</span>
<span style="color: #ffa54f;">daemon:x:6:</span>
<span style="color: #ffa54f;">disk:x:8:</span>
<span style="color: #ffa54f;">dialout:x:10:</span>
<span style="color: #ffa54f;">video:x:12:</span>
<span style="color: #ffa54f;">utmp:x:13:</span>
<span style="color: #ffa54f;">usb:x:14:</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
创建 <code>/etc/fstab</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="color: #a0522d;">LJOS</span>}/etc/fstab &lt;&lt; <span style="color: #8b2252;">"EOF"</span>
<span style="color: #ffa54f;"># file system  mount-point  type   options          dump  fsck</span>
<span style="color: #ffa54f;">#                                                         order</span>

<span style="color: #ffa54f;">rootfs          /               auto    defaults        1      1</span>
<span style="color: #ffa54f;">proc            /proc           proc    defaults        0      0</span>
<span style="color: #ffa54f;">sysfs           /sys            sysfs   defaults        0      0</span>
<span style="color: #ffa54f;">devpts          /dev/pts        devpts  gid=4,mode=620  0      0</span>
<span style="color: #ffa54f;">tmpfs           /dev/shm        tmpfs   defaults        0      0</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
创建 <code>/etc/profile</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="color: #a0522d;">LJOS</span>}/etc/profile &lt;&lt; <span style="color: #8b2252;">"EOF"</span>
<span style="color: #ffa54f;">export PATH=/bin:/usr/bin</span>

<span style="color: #ffa54f;">if [ `id -u` -eq 0 ] ; then</span>
<span style="color: #ffa54f;">        PATH=/bin:/sbin:/usr/bin:/usr/sbin</span>
<span style="color: #ffa54f;">        unset HISTFILE</span>
<span style="color: #ffa54f;">fi</span>


<span style="color: #ffa54f;"># Set up some environment variables.</span>
<span style="color: #ffa54f;">export USER=`id -un`</span>
<span style="color: #ffa54f;">export LOGNAME=$USER</span>
<span style="color: #ffa54f;">export HOSTNAME=`/bin/hostname`</span>
<span style="color: #ffa54f;">export HISTSIZE=1000</span>
<span style="color: #ffa54f;">export HISTFILESIZE=1000</span>
<span style="color: #ffa54f;">export PAGER='/bin/more '</span>
<span style="color: #ffa54f;">export EDITOR='/bin/vi'</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
设置主机名
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"LFS"</span> &gt; ${<span style="color: #a0522d;">LJOS</span>}/etc/HOSTNAME
</pre>
</div>

<p>
设置登陆提示
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="color: #a0522d;">LJOS</span>}/etc/issue&lt;&lt; <span style="color: #8b2252;">"EOF"</span>
<span style="color: #ffa54f;">Linux From Scratch OS 0.1a</span>
<span style="color: #ffa54f;">Kernel \r on an \m</span>

<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
为了简单期间，使用BusyBox的 init 进程作为初始化进程，因此需要定义 <code>/etc/inittab</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="color: #a0522d;">LJOS</span>}/etc/inittab&lt;&lt; <span style="color: #8b2252;">"EOF"</span>
<span style="color: #ffa54f;">::sysinit:/etc/rc.d/startup</span>

<span style="color: #ffa54f;">tty1::respawn:/sbin/getty 38400 tty1</span>
<span style="color: #ffa54f;">tty2::respawn:/sbin/getty 38400 tty2</span>
<span style="color: #ffa54f;">tty3::respawn:/sbin/getty 38400 tty3</span>
<span style="color: #ffa54f;">tty4::respawn:/sbin/getty 38400 tty4</span>
<span style="color: #ffa54f;">tty5::respawn:/sbin/getty 38400 tty5</span>
<span style="color: #ffa54f;">tty6::respawn:/sbin/getty 38400 tty6</span>

<span style="color: #ffa54f;">::shutdown:/etc/rc.d/shutdown</span>
<span style="color: #ffa54f;">::ctrlaltdel:/sbin/reboot</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
同样的，BusyBox 使用mdev代替udev，因此需要定义 <code>/etc/mdev</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="color: #a0522d;">LJOS</span>}/etc/mdev.conf&lt;&lt; <span style="color: #8b2252;">"EOF"</span>
<span style="color: #ffa54f;"># Devices:</span>
<span style="color: #ffa54f;"># Syntax: %s %d:%d %s</span>
<span style="color: #ffa54f;"># devices user:group mode</span>

<span style="color: #ffa54f;"># null does already exist; therefore ownership has to</span>
<span style="color: #ffa54f;"># be changed with command</span>
<span style="color: #ffa54f;">null    root:root 0666  @chmod 666 $MDEV</span>
<span style="color: #ffa54f;">zero    root:root 0666</span>
<span style="color: #ffa54f;">grsec   root:root 0660</span>
<span style="color: #ffa54f;">full    root:root 0666</span>

<span style="color: #ffa54f;">random  root:root 0666</span>
<span style="color: #ffa54f;">urandom root:root 0444</span>
<span style="color: #ffa54f;">hwrandom root:root 0660</span>

<span style="color: #ffa54f;"># console does already exist; therefore ownership has to</span>
<span style="color: #ffa54f;"># be changed with command</span>
<span style="color: #ffa54f;">console root:tty 0600 @mkdir -pm 755 fd &amp;&amp; cd fd &amp;&amp; for x</span>
<span style="color: #ffa54f;"> &#8618;in 0 1 2 3 ; do ln -sf /proc/self/fd/$x $x; done</span>

<span style="color: #ffa54f;">kmem    root:root 0640</span>
<span style="color: #ffa54f;">mem     root:root 0640</span>
<span style="color: #ffa54f;">port    root:root 0640</span>
<span style="color: #ffa54f;">ptmx    root:tty 0666</span>

<span style="color: #ffa54f;"># ram.*</span>
<span style="color: #ffa54f;">ram([0-9]*)     root:disk 0660 &gt;rd/%1</span>
<span style="color: #ffa54f;">loop([0-9]+)    root:disk 0660 &gt;loop/%1</span>
<span style="color: #ffa54f;">sd[a-z].*       root:disk 0660 */lib/mdev/usbdisk_link</span>
<span style="color: #ffa54f;">hd[a-z][0-9]*   root:disk 0660 */lib/mdev/ide_links</span>

<span style="color: #ffa54f;">tty             root:tty 0666</span>
<span style="color: #ffa54f;">tty[0-9]        root:root 0600</span>
<span style="color: #ffa54f;">tty[0-9][0-9]   root:tty 0660</span>
<span style="color: #ffa54f;">ttyO[0-9]*      root:tty 0660</span>
<span style="color: #ffa54f;">pty.*           root:tty 0660</span>
<span style="color: #ffa54f;">vcs[0-9]*       root:tty 0660</span>
<span style="color: #ffa54f;">vcsa[0-9]*      root:tty 0660</span>

<span style="color: #ffa54f;">ttyLTM[0-9]     root:dialout 0660 @ln -sf $MDEV modem</span>
<span style="color: #ffa54f;">ttySHSF[0-9]    root:dialout 0660 @ln -sf $MDEV modem</span>
<span style="color: #ffa54f;">slamr           root:dialout 0660 @ln -sf $MDEV slamr0</span>
<span style="color: #ffa54f;">slusb           root:dialout 0660 @ln -sf $MDEV slusb0</span>
<span style="color: #ffa54f;">fuse            root:root  0666</span>

<span style="color: #ffa54f;"># misc stuff</span>
<span style="color: #ffa54f;">agpgart         root:root 0660  &gt;misc/</span>
<span style="color: #ffa54f;">psaux           root:root 0660  &gt;misc/</span>
<span style="color: #ffa54f;">rtc             root:root 0664  &gt;misc/</span>

<span style="color: #ffa54f;"># input stuff</span>
<span style="color: #ffa54f;">event[0-9]+     root:root 0640 =input/</span>
<span style="color: #ffa54f;">ts[0-9]         root:root 0600 =input/</span>

<span style="color: #ffa54f;"># v4l stuff</span>
<span style="color: #ffa54f;">vbi[0-9]        root:video 0660 &gt;v4l/</span>
<span style="color: #ffa54f;">video[0-9]      root:video 0660 &gt;v4l/</span>

<span style="color: #ffa54f;"># load drivers for usb devices</span>
<span style="color: #ffa54f;">usbdev[0-9].[0-9]       root:root 0660 */lib/mdev/usbdev</span>
<span style="color: #ffa54f;">usbdev[0-9].[0-9]_.*    root:root 0660</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
为GRUB引导器创建配置文件
</p>
<div class="org-src-container">
<pre class="src src-shell">cat &gt; ${<span style="color: #a0522d;">LJOS</span>}/boot/grub/grub.cfg&lt;&lt; <span style="color: #8b2252;">"EOF"</span>

<span style="color: #ffa54f;">set default=0</span>
<span style="color: #ffa54f;">set timeout=5</span>

<span style="color: #ffa54f;">set root=(hd0,1)</span>

<span style="color: #ffa54f;">menuentry "Linux From Scratch OS" {</span>
<span style="color: #ffa54f;">        linux   /boot/vmlinuz-4.16.3 root=/dev/sda1 ro quiet</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
创建日志文件
</p>
<div class="org-src-container">
<pre class="src src-shell">touch ${<span style="color: #a0522d;">LJOS</span>}/var/run/utmp ${<span style="color: #a0522d;">LJOS</span>}/var/log/{btmp,lastlog,wtmp}
chmod -v 664 ${<span style="color: #a0522d;">LJOS</span>}/var/run/utmp ${<span style="color: #a0522d;">LJOS</span>}/var/log/lastlog
</pre>
</div></li>
</ol>
</div>
</div>


<div id="outline-container-orgffa2ef9" class="outline-2">
<h2 id="orgffa2ef9">构建交叉编译器</h2>
<div class="outline-text-2" id="text-orgffa2ef9">
</div>
<div id="outline-container-orga46d1d2" class="outline-3">
<h3 id="orga46d1d2">设置好编译相关的变量</h3>
<div class="outline-text-3" id="text-orga46d1d2">
<p>
清空host上预设的 C/C++ 编译标志
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">unset</span> CFLAGS
<span style="color: #483d8b;">unset</span> CXXFLAGS
</pre>
</div>

<p>
定义其他交叉编译过程中使用的变量
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">export</span> <span style="color: #a0522d;">LJOS_HOST</span>=$(<span style="color: #ff00ff;">echo</span> ${<span style="color: #a0522d;">MACHTYPE</span>} | sed <span style="color: #8b2252;">"s/-[^-]*/-cross/"</span>)
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">LJOS_TARGET</span>=x86_64-unknown-linux-gnu
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">LJOS_CPU</span>=k4
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">LJOS_ARCH</span>=$(<span style="color: #ff00ff;">echo</span> ${<span style="color: #a0522d;">LJOS_TARGET</span>} | sed -e <span style="color: #8b2252;">'s/-.*//'</span> -e <span style="color: #8b2252;">'s/i.86/i386/'</span>)
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">LJOS_ENDIAN</span>=little
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd8b744b" class="outline-3">
<h3 id="orgd8b744b">安装kernel headers</h3>
<div class="outline-text-3" id="text-orgd8b744b">
<p>
从<a href="https://www.kernel.org/">kernel.org</a>下载内核源码
</p>
<div class="org-src-container">
<pre class="src src-shell">wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.18.4.tar.xz
</pre>
</div>

<p>
解压源代码
</p>
<div class="org-src-container">
<pre class="src src-shell">tar -xf linux-4.18.4.tar.xz 
</pre>
</div>

<p>
编译kernel headers
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> linux-4.18.4/
make mrproper
make <span style="color: #a0522d;">ARCH</span>=${<span style="color: #a0522d;">LJOS_ARCH</span>} headers_check &amp;&amp; <span style="color: #8b2252;">\</span>
make <span style="color: #a0522d;">ARCH</span>=${<span style="color: #a0522d;">LJOS_ARCH</span>} <span style="color: #a0522d;">INSTALL_HDR_PATH</span>=dest headers_install
cp -rv dest/include/* ${<span style="color: #a0522d;">LJOS</span>}/usr/include
</pre>
</div>
</div>
</div>

<div id="outline-container-org1050e67" class="outline-3">
<h3 id="org1050e67">安装Binutils</h3>
<div class="outline-text-3" id="text-org1050e67">
<p>
下载bintuils源代码
</p>
<div class="org-src-container">
<pre class="src src-shell">wget http://ftp.gnu.org/gnu/binutils/binutils-2.31.tar.xz
</pre>
</div>

<p>
解压源代码
</p>
<div class="org-src-container">
<pre class="src src-shell">tar -xf binutils-2.31.tar.xz
</pre>
</div>

<p>
编译binutils
</p>
<div class="org-src-container">
<pre class="src src-shell">./configure --prefix=${<span style="color: #a0522d;">LJOS</span>}/cross-tools <span style="color: #8b2252;">\</span>
--target=${<span style="color: #a0522d;">LJOS_TARGET</span>} --with-sysroot=${<span style="color: #a0522d;">LJOS</span>} <span style="color: #8b2252;">\</span>
--disable-nls --enable-shared --disable-multilib
make configure-host &amp;&amp; make
ln -sv lib ${<span style="color: #a0522d;">LJOS</span>}/cross-tools/lib64
make install
cp -v include/libiberty.h ${<span style="color: #a0522d;">LJOS</span>}/usr/include
</pre>
</div>
</div>
</div>

<div id="outline-container-org74e640c" class="outline-3">
<h3 id="org74e640c">静态编译的gcc</h3>
<div class="outline-text-3" id="text-org74e640c">
<p>
下载 gcc，gmp，mpfr，mpc
</p>
<div class="org-src-container">
<pre class="src src-shell">wget http://ftp.gnu.org/gnu/gcc/gcc-8.2.0/gcc-8.2.0.tar.xz <span style="color: #8b2252;">\</span>
     http://ftp.gnu.org/gnu/gmp/gmp-6.1.2.tar.xz <span style="color: #8b2252;">\</span>
     http://ftp.gnu.org/gnu/mpfr/mpfr-4.0.1.tar.xz <span style="color: #8b2252;">\</span>
     http://ftp.gnu.org/gnu/mpc/mpc-1.1.0.tar.gz
</pre>
</div>

<p>
解压 gcc，gmp，mpfr，mpc
</p>
<div class="org-src-container">
<pre class="src src-shell">tar -xf gcc-8.2.0.tar.xz
tar -xf gmp-6.1.2.tar.xz
tar -xf mpfr-4.0.1.tar.xz
tar -xf mpc-1.1.0.tar.gz
</pre>
</div>

<p>
将gmp,mpfr,mpc移动到gcc目录下
</p>
<div class="org-src-container">
<pre class="src src-shell">mv gmp-6.1.2 gcc-8.2.0/gmp
mv mpfr-4.0.1 gcc-8.2.0/mpfr
mv mpc-1.1.0 gcc-8.2.0/mpc
</pre>
</div>

<p>
编译gcc
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir gcc-static
<span style="color: #483d8b;">cd</span> gcc-static/
<span style="color: #a0522d;">AR</span>=ar <span style="color: #a0522d;">LDFLAGS</span>=<span style="color: #8b2252;">"-Wl,-rpath,${LJOS}/cross-tools/lib"</span> <span style="color: #8b2252;">\</span>
../gcc-8.2.0/configure --prefix=${<span style="color: #a0522d;">LJOS</span>}/cross-tools <span style="color: #8b2252;">\</span>
--build=${<span style="color: #a0522d;">LJOS_HOST</span>} --host=${<span style="color: #a0522d;">LJOS_HOST</span>} <span style="color: #8b2252;">\</span>
--target=${<span style="color: #a0522d;">LJOS_TARGET</span>} <span style="color: #8b2252;">\</span>
--with-sysroot=${<span style="color: #a0522d;">LJOS</span>}/target --disable-nls <span style="color: #8b2252;">\</span>
--disable-shared <span style="color: #8b2252;">\</span>
--with-mpfr-include=$(<span style="color: #ff00ff;">pwd</span>)/../gcc-8.2.0/mpfr/src <span style="color: #8b2252;">\</span>
--with-mpfr-lib=$(<span style="color: #ff00ff;">pwd</span>)/mpfr/src/.libs <span style="color: #8b2252;">\</span>
--without-headers --with-newlib --disable-decimal-float <span style="color: #8b2252;">\</span>
--disable-libgomp --disable-libmudflap --disable-libssp <span style="color: #8b2252;">\</span>
--disable-threads --enable-languages=c,c++ <span style="color: #8b2252;">\</span>
--disable-multilib --with-arch=${<span style="color: #a0522d;">LJOS_CPU</span>}
make all-gcc all-target-libgcc &amp;&amp; <span style="color: #8b2252;">\</span>
make install-gcc install-target-libgcc
ln -vs libgcc.a $(${<span style="color: #a0522d;">LJOS_TARGET</span>}-gcc -print-libgcc-file-name | sed <span style="color: #8b2252;">'s/libgcc/&amp;_eh/'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6fb7de3" class="outline-3">
<h3 id="org6fb7de3">编译Glibc</h3>
<div class="outline-text-3" id="text-org6fb7de3">
<p>
下载glibc
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> ..
wget http://ftp.gnu.org/gnu/glibc/glibc-2.28.tar.xz
</pre>
</div>

<p>
解压glibc
</p>
<div class="org-src-container">
<pre class="src src-shell">tar -xf glibc-2.28.tar.xz
</pre>
</div>

<p>
编译glibc
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir glibc-build
<span style="color: #483d8b;">cd</span> glibc-build/
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"libc_cv_forced_unwind=yes"</span> &gt; config.cache
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"libc_cv_c_cleanup=yes"</span> &gt;&gt; config.cache
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"libc_cv_ssp=no"</span> &gt;&gt; config.cache
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"libc_cv_ssp_strong=no"</span> &gt;&gt; config.cache
<span style="color: #a0522d;">BUILD_CC</span>=<span style="color: #8b2252;">"gcc"</span> <span style="color: #a0522d;">CC</span>=<span style="color: #8b2252;">"${LJOS_TARGET}-gcc"</span> <span style="color: #8b2252;">\</span>
<span style="color: #a0522d;">AR</span>=<span style="color: #8b2252;">"${LJOS_TARGET}-ar"</span> <span style="color: #8b2252;">\</span>
<span style="color: #a0522d;">RANLIB</span>=<span style="color: #8b2252;">"${LJOS_TARGET}-ranlib"</span> <span style="color: #a0522d;">CFLAGS</span>=<span style="color: #8b2252;">"-O2"</span> <span style="color: #8b2252;">\</span>
../glibc-2.28/configure --prefix=/usr <span style="color: #8b2252;">\</span>
--host=${<span style="color: #a0522d;">LJOS_TARGET</span>} --build=${<span style="color: #a0522d;">LJOS_HOST</span>} <span style="color: #8b2252;">\</span>
--disable-profile --enable-add-ons --with-tls <span style="color: #8b2252;">\</span>
--enable-kernel=2.6.32 --with-__thread <span style="color: #8b2252;">\</span>
--with-binutils=${<span style="color: #a0522d;">LJOS</span>}/cross-tools/bin <span style="color: #8b2252;">\</span>
--with-headers=${<span style="color: #a0522d;">LJOS</span>}/usr/include <span style="color: #8b2252;">\</span>
--cache-file=config.cache
make &amp;&amp; make <span style="color: #a0522d;">install_root</span>=${<span style="color: #a0522d;">LJOS</span>}/ install
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb5e313a" class="outline-3">
<h3 id="orgb5e313a">最后再编译一次GCC，这次这个GCC会链接到上一步编译出来的Glibc中</h3>
<div class="outline-text-3" id="text-orgb5e313a">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> ..
mkdir gcc-build
<span style="color: #483d8b;">cd</span> gcc-build/
<span style="color: #a0522d;">AR</span>=ar <span style="color: #a0522d;">LDFLAGS</span>=<span style="color: #8b2252;">"-Wl,-rpath,${LJOS}/cross-tools/lib"</span> <span style="color: #8b2252;">\</span>
../gcc-8.2.0/configure --prefix=${<span style="color: #a0522d;">LJOS</span>}/cross-tools <span style="color: #8b2252;">\</span>
--build=${<span style="color: #a0522d;">LJOS_HOST</span>} --target=${<span style="color: #a0522d;">LJOS_TARGET</span>} <span style="color: #8b2252;">\</span>
--host=${<span style="color: #a0522d;">LJOS_HOST</span>} --with-sysroot=${<span style="color: #a0522d;">LJOS</span>} <span style="color: #8b2252;">\</span>
--disable-nls --enable-shared <span style="color: #8b2252;">\</span>
--enable-languages=c,c++ --enable-c99 <span style="color: #8b2252;">\</span>
--enable-long-long <span style="color: #8b2252;">\</span>
--with-mpfr-include=$(<span style="color: #ff00ff;">pwd</span>)/../gcc-8.2.0/mpfr/src <span style="color: #8b2252;">\</span>
--with-mpfr-lib=$(<span style="color: #ff00ff;">pwd</span>)/mpfr/src/.libs <span style="color: #8b2252;">\</span>
--disable-multilib --with-arch=${<span style="color: #a0522d;">LJOS_CPU</span>}
make &amp;&amp; make install
cp -v ${<span style="color: #a0522d;">LJOS</span>}/cross-tools/${<span style="color: #a0522d;">LJOS_TARGET</span>}/lib64/libgcc_s.so.1 ${<span style="color: #a0522d;">LJOS</span>}/lib64
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge9accd8" class="outline-2">
<h2 id="orge9accd8">构建Target Image</h2>
<div class="outline-text-2" id="text-orge9accd8">
</div>
<div id="outline-container-orgc308bf0" class="outline-3">
<h3 id="orgc308bf0">构建BusyBox</h3>
<div class="outline-text-3" id="text-orgc308bf0">
<p>
下载 BusyBox
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> ..
wget http://busybox.net/downloads/busybox-1.29.2.tar.bz2
</pre>
</div>

<p>
解压源码包
</p>
<div class="org-src-container">
<pre class="src src-shell">tar -xf busybox-1.29.2.tar.bz2
</pre>
</div>

<p>
编译BusyBox
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> busybox-1.29.2/
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#40664;&#35748;&#30340;&#32534;&#35793;&#37197;&#32622;&#25991;&#20214;</span>
make <span style="color: #a0522d;">CROSS_COMPILE</span>=<span style="color: #8b2252;">"${LJOS_TARGET}-"</span> defconfig
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#38656;&#35201;&#30340;&#35805;&#65292;&#21487;&#20197;&#36890;&#36807;menuconfig&#26469;&#23545;&#37197;&#32622;&#23601;&#20687;&#35843;&#25972;</span>
make <span style="color: #a0522d;">CROSS_COMPILE</span>=<span style="color: #8b2252;">"${LJOS_TARGET}-"</span> menuconfig
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32534;&#35793;</span>
make <span style="color: #a0522d;">CROSS_COMPILE</span>=<span style="color: #8b2252;">"${LJOS_TARGET}-"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;</span>
make <span style="color: #a0522d;">CROSS_COMPILE</span>=<span style="color: #8b2252;">"${LJOS_TARGET}-"</span> <span style="color: #8b2252;">\</span>
<span style="color: #a0522d;">CONFIG_PREFIX</span>=<span style="color: #8b2252;">"${LJOS}"</span> install
</pre>
</div>

<p>
拷贝depmod.pl,后面构建kernel的时候要用
</p>
<div class="org-src-container">
<pre class="src src-shell">cp -v examples/depmod.pl ${<span style="color: #a0522d;">LJOS</span>}/cross-tools/bin
chmod 755 ${<span style="color: #a0522d;">LJOS</span>}/cross-tools/bin/depmod.pl
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcbabe8f" class="outline-3">
<h3 id="orgcbabe8f">构建linux kernel</h3>
<div class="outline-text-3" id="text-orgcbabe8f">
<p>
生成默认的x86-64的配置文件
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> ../linux-4.18.4/
make <span style="color: #a0522d;">ARCH</span>=${<span style="color: #a0522d;">LJOS_ARCH</span>} <span style="color: #8b2252;">\</span>
     <span style="color: #a0522d;">CROSS_COMPILE</span>=${<span style="color: #a0522d;">LJOS_TARGET</span>}- x86_64_defconfig
</pre>
</div>

<p>
当然，你也可以通过 <code>make menuconfig</code> 进行微调
</p>

<p>
比如安装Target Image到VirutalBox虚拟机中，则需要安装 Intel 的 <code>e1000</code> 网卡模块以及 LSI 的 <code>mpt2sas</code> 模块
</p>
<div class="org-src-container">
<pre class="src src-shell">make <span style="color: #a0522d;">ARCH</span>=${<span style="color: #a0522d;">LJOS_ARCH</span>} <span style="color: #8b2252;">\</span>
     <span style="color: #a0522d;">CROSS_COMPILE</span>=${<span style="color: #a0522d;">LJOS_TARGET</span>}- menuconfig
</pre>
</div>

<p>
编译并安装kernel
</p>
<div class="org-src-container">
<pre class="src src-shell">make <span style="color: #a0522d;">ARCH</span>=${<span style="color: #a0522d;">LJOS_ARCH</span>} <span style="color: #8b2252;">\</span>
     <span style="color: #a0522d;">CROSS_COMPILE</span>=${<span style="color: #a0522d;">LJOS_TARGET</span>}-
make <span style="color: #a0522d;">ARCH</span>=${<span style="color: #a0522d;">LJOS_ARCH</span>} <span style="color: #8b2252;">\</span>
     <span style="color: #a0522d;">CROSS_COMPILE</span>=${<span style="color: #a0522d;">LJOS_TARGET</span>}- <span style="color: #8b2252;">\</span>
     <span style="color: #a0522d;">INSTALL_MOD_PATH</span>=${<span style="color: #a0522d;">LJOS</span>} modules_install
</pre>
</div>

<p>
拷贝文件到 target 的 <code>/boot</code> 目录下
</p>
<div class="org-src-container">
<pre class="src src-shell">cp -v arch/x86/boot/bzImage ${<span style="color: #a0522d;">LJOS</span>}/boot/vmlinuz-4.18.4
cp -v System.map ${<span style="color: #a0522d;">LJOS</span>}/boot/System.map-4.18.4
cp -v .config ${<span style="color: #a0522d;">LJOS</span>}/boot/config-4.18.4
</pre>
</div>

<p>
运行 <code>depmod.pl</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">${<span style="color: #a0522d;">LJOS</span>}/cross-tools/bin/depmod.pl <span style="color: #8b2252;">\</span>
      -F ${<span style="color: #a0522d;">LJOS</span>}/boot/System.map-4.18.4 <span style="color: #8b2252;">\</span>
      -b ${<span style="color: #a0522d;">LJOS</span>}/lib/modules/4.18.4
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaf926f8" class="outline-3">
<h3 id="orgaf926f8">Bootscripts</h3>
</div>
</div>

</div>
</div>
<div>
  <div class="post-meta">
    <span title="post date" class="post-info">2018-08-24</span>
    <span title="last modification date" class="post-info">2018-10-15</span>
    <span title="tags" class="post-info"><a href="https://lujun9972.github.io/tags/linux和它的小伙伴">linux和它的小伙伴</a></span>
    <span title="author" class="post-info">lujun9972</span>
  </div>
  <script src="https://lujun9972.github.io/media/js/jquery-2.1.3.min.js"></script>
  <section>
    <h1>Comments</h1>
    <div id="comment-wrap">
      <a class="disqus_label">使用Disqus评论</a>
      <a class="ds-label">使用多说评论</a>
    </ul>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
     //var disqus_developer = 1;
     var preempt_signal=false;
     var disqus_identifier = "/blog/2018/08/24/lfs/";
     var disqus_url = "https://lujun9972.github.io/blog/2018/08/24/lfs/";
     var disqus_shortname = 'lujun9972';
     /* * * DON'T EDIT BELOW THIS LINE * * */
     (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       $('#disqus_thread').css('display','none');
     })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>
  <script src="https://lujun9972.github.io/media/js/kdComment.js"></script>
  <div class="footer">
    <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
    <p>
      Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; T430S">lujun9972</a>
      &nbsp;&nbsp;-&nbsp;&nbsp;
      Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a><br/>
      Themed with <a href="https://github.com/kuangdash/emacs_love" target="_blank">emacs_love</a>
      <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
    </p>
  </div>
    </div>

  </body>
</html>
